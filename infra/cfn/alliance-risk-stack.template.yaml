AWSTemplateFormatVersion: "2010-09-09"
Description: "CGIAR Risk Intelligence Tool — MVP infrastructure"

# ─────────────────────────────────────────────────────────────────────────────
# Parameters
# ─────────────────────────────────────────────────────────────────────────────
Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: [dev, staging, production]
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC for RDS security group
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Public subnets for RDS
  ApiCodeS3Bucket:
    Type: String
    Description: S3 bucket containing Lambda deployment packages
  ApiCodeS3Key:
    Type: String
    Description: S3 key for the API/Worker Lambda zip
  CorsOrigin:
    Type: String
    Default: "*"
    Description: Allowed CORS origin for the API

# ─────────────────────────────────────────────────────────────────────────────
# Resources
# ─────────────────────────────────────────────────────────────────────────────
Resources:

  # ── Cognito ────────────────────────────────────────────────────────────────
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: alliance-risk-user-pool
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: true
      UsernameAttributes: [email]
      AutoVerifiedAttributes: [email]
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      Policies:
        PasswordPolicy:
          MinimumLength: 12
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: true
          TemporaryPasswordValidityDays: 7
    DeletionPolicy: Retain

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: alliance-risk-api-client
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      AccessTokenValidity: 60
      IdTokenValidity: 60
      RefreshTokenValidity: 43200
      TokenValidityUnits:
        AccessToken: minutes
        IdToken: minutes
        RefreshToken: minutes

  AdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref UserPool
      GroupName: admin
      Description: Platform administrators

  # ── Lambda Security Group (for VPC placement) ─────────────────────────────
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions to access RDS
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic

  # ── RDS PostgreSQL ─────────────────────────────────────────────────────────
  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Alliance Risk RDS instance
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !GetAtt LambdaSecurityGroup.GroupId
          Description: Allow PostgreSQL from Lambda functions only

  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for Alliance Risk database
      SubnetIds: !Ref SubnetIds

  DbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: alliance-risk/db-credentials
      GenerateSecretString:
        SecretStringTemplate: '{"username":"postgres"}'
        GenerateStringKey: password
        PasswordLength: 30
        ExcludeCharacters: " %+~`#$&*()|[]{}:;<>?!'/@\"\\"
    DeletionPolicy: Retain

  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: postgres
      EngineVersion: "15"
      DBInstanceClass: db.t3.micro
      AllocatedStorage: "20"
      StorageType: gp3
      DBName: alliance_risk
      MasterUsername: postgres
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
      DBSubnetGroupName: !Ref DbSubnetGroup
      VPCSecurityGroups:
        - !GetAtt DbSecurityGroup.GroupId
      PubliclyAccessible: false
      StorageEncrypted: true
      BackupRetentionPeriod: 7
      DeletionProtection: true
      CopyTagsToSnapshot: true
    DeletionPolicy: Snapshot

  DbSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref DbSecret
      TargetId: !Ref Database
      TargetType: AWS::RDS::DBInstance

  # ── S3 File Bucket ─────────────────────────────────────────────────────────
  FileBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "alliance-risk-files-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
    DeletionPolicy: Retain

  # ── IAM — Worker Lambda Role ───────────────────────────────────────────────
  WorkerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      Policies:
        - PolicyName: WorkerPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminInitiateAuth
                  - cognito-idp:AdminRespondToAuthChallenge
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminSetUserPassword
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:AdminEnableUser
                  - cognito-idp:AdminDisableUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminRemoveUserFromGroup
                  - cognito-idp:AdminListGroupsForUser
                  - cognito-idp:ListUsers
                  - cognito-idp:ListGroups
                  - cognito-idp:ForgotPassword
                  - cognito-idp:ConfirmForgotPassword
                Resource: !GetAtt UserPool.Arn
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:Retrieve
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-5-sonnet-*"
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-haiku-*"
              - Effect: Allow
                Action:
                  - textract:StartDocumentAnalysis
                  - textract:GetDocumentAnalysis
                Resource: !Sub "arn:${AWS::Partition}:textract:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "${FileBucket.Arn}/*"

  # ── Worker Lambda ──────────────────────────────────────────────────────────
  WorkerLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: alliance-risk-worker
      Runtime: nodejs20.x
      Architectures: [arm64]
      Handler: dist/src/worker.handler
      Code:
        S3Bucket: !Ref ApiCodeS3Bucket
        S3Key: !Ref ApiCodeS3Key
      MemorySize: 1024
      Timeout: 900
      Role: !GetAtt WorkerLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt LambdaSecurityGroup.GroupId
        SubnetIds: !Ref SubnetIds
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          DATABASE_URL: !Sub
            - "postgresql://${Username}:${Password}@${Host}:5432/alliance_risk"
            - Username: postgres
              Password: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
              Host: !GetAtt Database.Endpoint.Address

  # ── IAM — API Lambda Role ──────────────────────────────────────────────────
  ApiLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      Policies:
        - PolicyName: ApiPermissions
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminInitiateAuth
                  - cognito-idp:AdminRespondToAuthChallenge
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminSetUserPassword
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:AdminEnableUser
                  - cognito-idp:AdminDisableUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminRemoveUserFromGroup
                  - cognito-idp:AdminListGroupsForUser
                  - cognito-idp:ListUsers
                  - cognito-idp:ListGroups
                  - cognito-idp:ForgotPassword
                  - cognito-idp:ConfirmForgotPassword
                Resource: !GetAtt UserPool.Arn
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:Retrieve
                Resource:
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-5-sonnet-*"
                  - !Sub "arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-haiku-*"
              - Effect: Allow
                Action:
                  - textract:StartDocumentAnalysis
                  - textract:GetDocumentAnalysis
                Resource: !Sub "arn:${AWS::Partition}:textract:${AWS::Region}:${AWS::AccountId}:*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "${FileBucket.Arn}/*"
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt WorkerLambda.Arn

  # ── API Lambda ─────────────────────────────────────────────────────────────
  ApiLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: alliance-risk-api
      Runtime: nodejs20.x
      Architectures: [arm64]
      Handler: dist/src/lambda.handler
      Code:
        S3Bucket: !Ref ApiCodeS3Bucket
        S3Key: !Ref ApiCodeS3Key
      MemorySize: 1024
      Timeout: 29
      Role: !GetAtt ApiLambdaRole.Arn
      VpcConfig:
        SecurityGroupIds:
          - !GetAtt LambdaSecurityGroup.GroupId
        SubnetIds: !Ref SubnetIds
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
          COGNITO_USER_POOL_ID: !Ref UserPool
          COGNITO_CLIENT_ID: !Ref UserPoolClient
          S3_BUCKET_NAME: !Ref FileBucket
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
          WORKER_FUNCTION_NAME: !Ref WorkerLambda
          CORS_ORIGIN: !Ref CorsOrigin
          DATABASE_URL: !Sub
            - "postgresql://${Username}:${Password}@${Host}:5432/alliance_risk"
            - Username: postgres
              Password: !Sub "{{resolve:secretsmanager:${DbSecret}:SecretString:password}}"
              Host: !GetAtt Database.Endpoint.Address

  # ── API Gateway HTTP API ───────────────────────────────────────────────────
  HttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: alliance-risk-api
      ProtocolType: HTTP
      CorsConfiguration:
        AllowHeaders: [Content-Type, Authorization]
        AllowMethods: [GET, POST, PUT, DELETE, OPTIONS, PATCH]
        AllowOrigins: [!Ref CorsOrigin]
        AllowCredentials: true
        MaxAge: 86400

  HttpApiIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref HttpApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !GetAtt ApiLambda.Arn
      PayloadFormatVersion: "2.0"

  HttpApiDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpApi
      RouteKey: $default
      AuthorizationType: NONE
      Target: !Sub "integrations/${HttpApiIntegration}"

  HttpApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref HttpApi
      StageName: $default
      AutoDeploy: true

  ApiLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt ApiLambda.Arn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HttpApi}/*/*"

  # ── Frontend S3 + CloudFront ───────────────────────────────────────────────
  WebBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "alliance-risk-web-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
    DeletionPolicy: Delete

  WebOAI:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: Alliance Risk web bucket OAI

  WebBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser: !GetAtt WebOAI.S3CanonicalUserId
            Action: s3:GetObject
            Resource: !Sub "${WebBucket.Arn}/*"

  WebDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        HttpVersion: http2
        IPV6Enabled: true
        PriceClass: PriceClass_100
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${WebOAI}"
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # CachingOptimized
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0

# ─────────────────────────────────────────────────────────────────────────────
# Outputs
# ─────────────────────────────────────────────────────────────────────────────
Outputs:
  ApiUrl:
    Description: API Gateway HTTP API endpoint URL
    Value: !GetAtt HttpApi.ApiEndpoint
    Export:
      Name: AllianceRiskApiUrl
  CloudFrontUrl:
    Description: CloudFront distribution URL for the frontend
    Value: !Sub "https://${WebDistribution.DomainName}"
    Export:
      Name: AllianceRiskCloudFrontUrl
  CognitoUserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: AllianceRiskCognitoUserPoolId
  CognitoClientId:
    Description: Cognito App Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: AllianceRiskCognitoClientId
  FileBucketName:
    Description: S3 bucket name for file storage
    Value: !Ref FileBucket
    Export:
      Name: AllianceRiskFileBucketName
  WebBucketName:
    Description: S3 bucket name for static web hosting
    Value: !Ref WebBucket
    Export:
      Name: AllianceRiskWebBucketName
  DatabaseEndpoint:
    Description: RDS PostgreSQL endpoint
    Value: !GetAtt Database.Endpoint.Address
  CloudFrontDistributionId:
    Description: CloudFront distribution ID (for cache invalidation)
    Value: !Ref WebDistribution
    Export:
      Name: AllianceRiskCloudFrontDistributionId
  DeployBucketName:
    Description: S3 bucket for Lambda deployment packages
    Value: !Ref ApiCodeS3Bucket
    Export:
      Name: AllianceRiskDeployBucketName
  WorkerLambdaName:
    Description: Worker Lambda function name
    Value: !Ref WorkerLambda
